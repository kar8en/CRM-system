{% extends 'main.html' %}

{% block content %}
<div class="d-flex" id="wrapper" style="background-color: #EFF2F7;">
    {% if user.is_authenticated %}
        <div class="container-fluid ms-25">
            <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                <button type="button" class="btn" style="background-color: #4a8fd4; color: white; border-radius: 0.5rem;" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="fas fa-filter"></i> Фильтры
                </button>
                <a href="{% url 'add_measurement' %}" class="btn bg-success text-white" style="border-radius: 0.5rem;">Добавить замер</a> 
            </div>

          <!-- Модальное окно для фильтров -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 0.5rem;">
            <div class="modal-header" style="background-color: #4a8fd4; color: white; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;">
                <h5 class="modal-title" id="filterModalLabel">Фильтры</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="get" action="{% url 'home' %}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Мастера:</label><br>
                        {% for master in masters %}
                            <div class="form-check">
                                <input type="checkbox" name="master" value="{{ master.id }}" id="master_{{ master.id }}" class="form-check-input"
                                    {% if master.id|stringformat:"s" in selected_master %}checked{% endif %}>
                                <label for="master_{{ master.id }}" class="form-check-label">{{ master.first_name }} {{ master.last_name }}</label>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="form-group mt-3">
                        <label>Статус:</label><br>
                        {% for status_key, status_value in STATUS_CHOICES %}
                            <div class="form-check">
                                <input type="checkbox" name="status" value="{{ status_key }}" id="status_{{ status_key }}" class="form-check-input"
                                    {% if status_key in selected_status %}checked{% endif %}>
                                <label for="status_{{ status_key }}" class="form-check-label">{{ status_value }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn" style="background-color: #4a8fd4; color: white; border-radius: 0.5rem;">Фильтровать</button>
                </div>
            </form>
        </div>
    </div>
</div>
            <!-- Таблица замеров -->
            <table class="table table-striped table-hover table-bordered mt-2 w-100 rounded"> 
                <thead style="background-color: #ffffff; color: #333; border-radius: 0.5rem;">
                    <tr>
                        <th scope="col" class="text-center">ID</th>
                        <th scope="col" class="text-center">Имя</th>
                        <th scope="col" class="text-center">Телефон</th>
                        <th scope="col" class="text-center">Адрес</th>
                        <th scope="col" class="text-center">Дата замера</th>  
                        <th scope="col" class="text-center">Время создания</th>
                        <th scope="col" class="text-center">Мастер</th>  
                        <th scope="col" class="text-center">Статус</th> 
                    </tr>
                </thead>
                <tbody>
                    {% if measurements %}
                        {% for measurement in measurements %}
                            <tr>
                                <td><a href="{% url 'measurement' measurement.id %}">{{ measurement.id }}</a></td>
                                <td>{{ measurement.first_name }} {{ measurement.last_name }}</td>
                                <td>{{ measurement.phone }}</td>
                                <td>{{ measurement.address }}</td>
                                <td>{{ measurement.measurement_date|date:"d.m.Y H:i" }}</td>  
                                <td>{{ measurement.created_at|date:"d.m.Y, H:i" }}</td> 
                                <td>{{ measurement.master.first_name }} {{ measurement.master.last_name }}</td>  
                                <td><span class="{% if measurement.status == 'created' %}bg-light text-dark{% elif measurement.status == 'accepted' %}bg-success text-white{% elif measurement.status == 'under_review' %}bg-warning text-dark{% elif measurement.status == 'rejected' %}bg-danger text-white{% endif %} badge rounded-pill">{{ measurement.get_status_display }}</span></td>  
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">Нет записей</td>  
                        </tr>
                    {% endif %}
                </tbody>
            </table>

        {% else %}
        <!-- Форма входа -->
        <div class="col-md-6 offset-md-3">
            <h1>Войти</h1><br/>
            <form method="POST" action="{% url 'home' %}">
                {% csrf_token %}
                <div class="mb-3">
                    <input type="text" class="form-control" name="username" placeholder="Username" required style="border-radius: 0.5rem;">
                </div><br/>
                <div class="mb-3">
                    <input type="password" class="form-control" name="password" placeholder="Password" required style="border-radius: 0.5rem;">
                </div><br/>
                <button type="submit" class="btn btn-secondary">Войти</button>
            </form>
        </div> 
        {% endif %}
    </div> 
</div>

<link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css'>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css'>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'></script>

{% endblock %}